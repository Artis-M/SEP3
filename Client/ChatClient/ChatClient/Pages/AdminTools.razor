@page "/AdminTools"
@using Microsoft.AspNetCore.Authorization
@using Services
@using System.Text.Json
@using MongoDB.Bson
@inject IChatroomService chatroomService;
@inject IJSRuntime JsRuntime;
@inject IAccountService AccountService;
@inject NavigationManager Nav;
@attribute [Authorize(Roles = "Admin")]

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>Admin Tools</h1>
            <button @onclick="goBack">Go back to hub</button>
        </div>
    </div>
    <div class="row">
        <div class="col-4">
            <h3>All Users</h3>
            <button @onclick="getAllusers">Get All Users</button>
            <div class="row">
                <div class="col-12">
                    @if (AllUsers.Any())
                    {
                        @foreach (var item in AllUsers)
                        {
                            <p>
                                @item.Username (@item._id) <button @onclick="() => deleteUser(item._id, item.Username)">Delete User</button>
                            </p>
                        }
                    }
                </div>
            </div>
        </div>
        <div class="col-4">
            <h3>All Chatrooms</h3>
            <button @onclick="getAllChatrooms">Get Chatrooms</button>
            <div class="row">
                <div class="col-12">
                    @if (AllChatrooms.Any())
                    {
                        @foreach (var item in AllChatrooms)
                        {
                            <p>
                                @item.name (@item._id) <button @onclick="() => deleteChatroom(item._id, item.name)">Delete Chatroom</button>
                                @if (item.participants.FirstOrDefault() != null)
                                {
@if (!(item.participants.Exists(users => users._id.Equals(user._id))))
{
    <button @onclick="() => JoinChatroom(item._id)">Join Chatroom</button>
}
                                }
                                else
                                {
                                    <button @onclick="() => JoinChatroom(item._id)">Join Chatroom</button>
                                }
                            </p>
                        }
                    }
                </div>
            </div>
        </div>
        <div class="col-4"></div>
    </div>
</div>

@code {
    private List<User> AllUsers = new List<User>();
    private List<Chatroom> AllChatrooms = new List<Chatroom>();
    private Account user;

    protected override async Task OnInitializedAsync()
    {
        string userAsJson = await JsRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentUser");
        if (!string.IsNullOrEmpty(userAsJson))
        {
            user = JsonSerializer.Deserialize<Account>(userAsJson);
        }
    }

    public async Task getAllusers()
    {
        HttpClient http = new HttpClient
        {
            BaseAddress = new Uri("https://localhost:5004/accounts")
        };
        try
        {
            AllUsers = JsonSerializer.Deserialize<List<User>>(await http.GetStringAsync(""));
            await InvokeAsync(() => StateHasChanged());
        }
        catch
        {
        }
    }

    public async Task getAllChatrooms()
    {
        HttpClient http = new HttpClient
        {
            BaseAddress = new Uri("https://localhost:5004/chatrooms")
        };
        try
        {
            AllChatrooms = JsonSerializer.Deserialize<List<Chatroom>>(await http.GetStringAsync(""));
            await InvokeAsync(() => StateHasChanged());
        }
        catch (Exception e)
        {
            Console.Out.WriteLine(e);
        }
    }

    private async Task deleteUser(string userID, string user)
    {
        try
        {
            bool response = await JsRuntime.InvokeAsync<bool>("confirmationPromt",
                $"Are you sure that you want to delete this account ({user}, {userID})? \n ***WARNING!*** \n This action cannot be undone!");
            if (response)
            {
                await AccountService.DeleteProfile(userID);
            }
        }
        catch (Exception e)
        {
            Console.Out.WriteLine(e);
        }
    }

    private async Task deleteChatroom(string chatroomID, string name)
    {
        bool response = await JsRuntime.InvokeAsync<bool>("confirmationPromt",
            $"Are you sure you want to delete the chatroom: {name}, ({chatroomID})? \n This action cannot be undone!");
        if (response)
        {
            Console.WriteLine("Deleting");
            await chatroomService.DeleteChatRoom(chatroomID);
            await getAllChatrooms();
        }
    }

    private async Task JoinChatroom(string id)
    {
        await chatroomService.JoinChatRoom(id, user._id);
        await EnterChatroom(id);
    }

    private async Task EnterChatroom(string id)
    {
        await chatroomService.SetCurrentChatroom(id);
        Nav.NavigateTo("");
    }

    private async Task goBack()
    {
        Nav.NavigateTo("main", true);
    }

}